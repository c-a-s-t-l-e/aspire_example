[{"name":"app.R","content":"library(shiny)\nlibrary(bslib)\nlibrary(DT)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(leaflet)\nlibrary(withr)\nlibrary(rmarkdown)\nlibrary(tinytex)\n\n# Example datasets\navailable_datasets <- list(\n  \"iris\" = iris,\n  \"mtcars\" = mtcars\n)\n\n# Define global reactive value\nglobal_filtered_data <- reactiveVal(NULL)\n\nui <- navbarPage(\n  theme = bs_theme(version = 5),\n  title = \"Data Explorer\",\n  \n  # Data Selection Tab\n  tabPanel(\n    \"Data Selection\",\n    page_sidebar(\n      sidebar = sidebar(\n        fileInput(\"file\", \"Upload CSV File\",\n                  accept = c(\"text/csv\",\n                             \"text/comma-separated-values,text/plain\",\n                             \".csv\")),\n        selectInput(\"dataset_choice\", \"Or Choose Example Dataset:\",\n                    choices = c(\"upload\", names(available_datasets))),\n        hr(),\n        h4(\"Filters\"),\n        uiOutput(\"dynamic_filters\")\n      ),\n      card(\n        card_header(\"Data Preview\"),\n        DTOutput(\"data_preview\"),\n        card_footer(\n          downloadButton(\"download_data\", \"Download Filtered Data\")\n        ),\n      ),\n      card(\n        card_header(\"Select Columns by Type\"),\n        uiOutput(\"column_selector_by_type\")\n      )\n    )\n  ),\n  \n  # Graph Generator Tab\n  tabPanel(\n    \"Graphs\",\n    page_sidebar(\n      # Replace the existing Graphs tabPanel sidebar content with:\n      sidebar = sidebar(\n        selectInput(\"plot_type\", \"Plot Type:\",\n                    choices = c(\"Scatter Plot\", \"Box Plot\", \"Histogram\", \"Bar Plot\")),\n        uiOutput(\"column_selector\"),\n        uiOutput(\"plot_options\"),\n        uiOutput(\"aesthetic_controls\"),  # New UI output for aesthetic controls\n        textInput(\"plot_title\", \"Plot Title:\", value = \"My Plot\"),\n        textInput(\"x_axis_label\", \"X-axis Label:\", value = \"X\"),\n        textInput(\"y_axis_label\", \"Y-axis Label:\", value = \"Y\"),\n        downloadButton(\"download_plot\", \"Download Plot\", class = \"btn-primary\")\n      ),\n      card(\n        card_header(\"Visualization\"),\n        plotOutput(\"plot\")\n      ),\n      card(\n        card_header(\"Statistical Analysis\"),\n        verbatimTextOutput(\"stats_tests\")\n      )\n    )\n  ),\n  # Report Generator Tab\n  tabPanel(\n    \"Report Generator\",\n    page_sidebar(\n      sidebar = sidebar(\n        textInput(\"report_title\", \"Report Title\", value = \"Data Analysis Report\"),\n        textAreaInput(\"report_description\", \"Report Description\", \n                      height = \"100px\",\n                      value = \"This report summarizes the analysis of our dataset.\"),\n        actionButton(\"save_current_plot\", \"Add Current Plot to Report\", class = \"btn-success\"),\n        hr(),\n        checkboxInput(\"include_data_summary\", \"Include Data Summary\", TRUE),\n        checkboxInput(\"include_stats\", \"Include Statistical Analysis\", TRUE),\n        actionButton(\"clear_report\", \"Clear Report\", class = \"btn-danger\"),\n        hr(),\n        downloadButton(\"download_report\", \"Download Report\", class = \"btn-primary\")\n      ),\n      card(\n        card_header(\"Report Preview\"),\n        card_body(\n          h2(textOutput(\"preview_title\")),\n          pre(style = \"white-space: pre-wrap; font-family: inherit;\", \n              textOutput(\"preview_description\")),\n          uiOutput(\"data_summary_preview\"),\n          hr(),\n          uiOutput(\"saved_plots_preview\"),\n          verbatimTextOutput(\"report_preview\")\n        )\n      )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n  # Reactive value to store the current dataset\n  current_data <- reactiveVal(NULL)\n  # Reactive value to store the filtered dataset\n  filtered_data <- reactiveVal(NULL)\n  # Add near the top of the server function\n  input_data_summary <- reactiveVal(TRUE)  # Default to TRUE\n  \n  # Update data when file is uploaded or dataset is selected\n  observeEvent(list(input$dataset_choice, input$file), {\n    if (input$dataset_choice == \"upload\") {\n      if (!is.null(input$file)) {\n        data <- read.csv(input$file$datapath)\n        current_data(data)\n        filtered_data(data)\n        global_filtered_data(data)\n      }\n    } else {\n      data <- available_datasets[[input$dataset_choice]]\n      current_data(data)\n      filtered_data(data)\n      global_filtered_data(data)\n    }\n  })\n  \n  # Function to get columns grouped by type\n  get_columns_by_type <- reactive({\n    req(current_data())\n    data <- current_data()\n    \n    list(\n      numeric = names(data)[sapply(data, is.numeric)],\n      factor = names(data)[sapply(data, is.factor)],\n      character = names(data)[sapply(data, is.character)],\n      other = names(data)[!sapply(data, function(x) \n        is.numeric(x) || is.factor(x) || is.character(x))]\n    )\n  })\n  \n  # Render column selector grouped by type\n  # Add this output in the Data Selection tab's UI\n  output$column_selector_by_type <- renderUI({\n    req(current_data())\n    cols_by_type <- get_columns_by_type()\n    \n    tagList(\n      checkboxGroupInput(\"selected_numeric\", \"Numeric Columns:\",\n                         choices = cols_by_type$numeric,\n                         selected = cols_by_type$numeric),\n      checkboxGroupInput(\"selected_factor\", \"Factor Columns:\",\n                         choices = cols_by_type$factor,\n                         selected = cols_by_type$factor),\n      checkboxGroupInput(\"selected_character\", \"Character Columns:\",\n                         choices = cols_by_type$character,\n                         selected = cols_by_type$character),\n      checkboxGroupInput(\"selected_other\", \"Other Columns:\",\n                         choices = cols_by_type$other,\n                         selected = cols_by_type$other)\n    )\n  })\n  \n  # Combine all selected columns\n  # Update the selected_cols reactive\n  selected_cols <- reactive({\n    req(current_data())\n    unique(c(\n      input$selected_numeric,\n      input$selected_factor,\n      input$selected_character,\n      input$selected_other\n    ))\n  })\n  \n  # Update the observe block that applies filters\n  observe({\n    req(current_data())\n    data <- current_data()\n    cols <- selected_cols()\n    \n    if (length(cols) > 0) {\n      filtered <- data\n      \n      for (col in cols) {\n        filter_input <- input[[paste0(\"filter_\", col)]]\n        \n        if (!is.null(filter_input)) {\n          if (is.numeric(data[[col]])) {\n            filtered <- filtered[\n              filtered[[col]] >= filter_input[1] & \n                filtered[[col]] <= filter_input[2], , drop = FALSE\n            ]\n          } else if (is.factor(data[[col]]) || is.character(data[[col]])) {\n            if (length(filter_input) > 0) {\n              filtered <- filtered[filtered[[col]] %in% filter_input, , drop = FALSE]\n            }\n          }\n        }\n      }\n      \n      filtered_data(filtered)\n      global_filtered_data(filtered)\n    } else {\n      filtered_data(data)\n      global_filtered_data(data)\n    }\n  })\n  \n  # Generate dynamic filters\n  output$dynamic_filters <- renderUI({\n    req(current_data())\n    data <- current_data()\n    cols <- selected_cols()\n    \n    filters <- lapply(cols, function(col) {\n      if (is.numeric(data[[col]])) {\n        rng <- range(data[[col]], na.rm = TRUE)\n        sliderInput(\n          inputId = paste0(\"filter_\", col),\n          label = paste(\"Filter\", col),\n          min = rng[1],\n          max = rng[2],\n          value = rng\n        )\n      } else if (is.factor(data[[col]]) || is.character(data[[col]])) {\n        choices <- unique(data[[col]])\n        selectInput(\n          inputId = paste0(\"filter_\", col),\n          label = paste(\"Filter\", col),\n          choices = choices,\n          multiple = TRUE,\n          selected = choices\n        )\n      }\n    })\n    \n    tagList(filters)\n  })\n  \n  # Apply filters and update filtered data\n  observe({\n    req(current_data())\n    data <- current_data()\n    cols <- selected_cols()\n    \n    if (length(cols) > 0) {\n      filtered <- data[, cols, drop = FALSE]\n      \n      for (col in cols) {\n        filter_input <- input[[paste0(\"filter_\", col)]]\n        \n        if (!is.null(filter_input)) {\n          if (is.numeric(filtered[[col]])) {\n            filtered <- filtered[\n              filtered[[col]] >= filter_input[1] & \n                filtered[[col]] <= filter_input[2],\n            ]\n          } else if (is.factor(filtered[[col]]) || is.character(filtered[[col]])) {\n            if (length(filter_input) > 0) {\n              filtered <- filtered[filtered[[col]] %in% filter_input, ]\n            }\n          }\n        }\n      }\n      \n      filtered_data(filtered)\n      global_filtered_data(filtered)\n    } else {\n      filtered_data(data)\n      global_filtered_data(data)\n    }\n  })\n  \n  # Render data preview\n  output$data_preview <- renderDT({\n    req(filtered_data())\n    datatable(filtered_data(),\n              options = list(pageLength = 10,\n                             scrollX = TRUE))\n  })\n  \n  # Download handler for filtered data\n  output$download_data <- downloadHandler(\n    filename = function() {\n      paste0(\"filtered_data_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".csv\")\n    },\n    content = function(file) {\n      req(filtered_data())\n      write.csv(filtered_data(), file, row.names = FALSE)\n    }\n  )\n  \n  # Graph tab functionality using filtered data\n  output$column_selector <- renderUI({\n    req(filtered_data())\n    data <- filtered_data()\n    num_cols <- names(data)[sapply(data, is.numeric)]\n    \n    tagList(\n      selectInput(\"x_var\", \"X Variable:\", choices = names(data)),\n      conditionalPanel(\n        condition = \"input.plot_type == 'Scatter Plot'\",\n        selectInput(\"y_var\", \"Y Variable:\", choices = num_cols)\n      )\n    )\n  })\n  \n  output$plot_options <- renderUI({\n    req(input$plot_type, filtered_data())\n    \n    if (input$plot_type == \"Histogram\") {\n      tagList(\n        sliderInput(\"bins\", \"Number of bins:\", min = 5, max = 50, value = 30),\n        checkboxInput(\"density\", \"Show density curve\", FALSE)\n      )\n    } else if (input$plot_type == \"Bar Plot\") {\n      checkboxInput(\"sort_bars\", \"Sort bars by frequency\", TRUE)\n    }\n  })\n  \n  output$aesthetic_controls <- renderUI({\n    req(filtered_data())\n    data <- filtered_data()\n    num_cols <- names(data)[sapply(data, is.numeric)]\n    cat_cols <- names(data)[sapply(data, function(x) is.factor(x) || is.character(x))]\n    \n    tagList(\n      selectInput(\"color_by\", \"Color by:\", \n                  choices = c(\"(None)\" = \"\", cat_cols)),\n      selectInput(\"size_by\", \"Size by:\", \n                  choices = c(\"(None)\" = \"\", num_cols)),\n      selectInput(\"facet_by\", \"Facet by:\", \n                  choices = c(\"(None)\" = \"\", cat_cols))\n    )\n  })\n  \n  current_plot <- reactive({\n    req(input$x_var, filtered_data())\n    data <- filtered_data()\n    \n    p <- switch(input$plot_type,\n                \"Scatter Plot\" = {\n                  req(input$y_var)\n                  p <- ggplot(data)\n                  \n                  # Build aesthetics based on selected options\n                  aes_list <- list(x = as.name(input$x_var), \n                                   y = as.name(input$y_var))\n                  \n                  if (input$color_by != \"\") {\n                    aes_list$color <- as.name(input$color_by)\n                  }\n                  if (input$size_by != \"\") {\n                    aes_list$size <- as.name(input$size_by)\n                  }\n                  \n                  p + do.call(aes, aes_list) +\n                    geom_point() +\n                    theme_minimal()\n                },\n                \"Box Plot\" = {\n                  p <- ggplot(data)\n                  \n                  # Build aesthetics for box plot\n                  aes_list <- list(y = as.name(input$x_var))\n                  if (input$color_by != \"\") {\n                    aes_list$x <- as.name(input$color_by)\n                    aes_list$fill <- as.name(input$color_by)\n                  }\n                  \n                  p + do.call(aes, aes_list) +\n                    geom_boxplot() +\n                    theme_minimal()\n                },\n                \"Histogram\" = {\n                  p <- ggplot(data)\n                  \n                  # Build aesthetics for histogram\n                  aes_list <- list(x = as.name(input$x_var))\n                  if (input$color_by != \"\") {\n                    aes_list$fill <- as.name(input$color_by)\n                  }\n                  \n                  p + do.call(aes, aes_list) +\n                    geom_histogram(bins = input$bins,\n                                   position = if(input$color_by != \"\") \"dodge\" else \"stack\") +\n                    theme_minimal()\n                },\n                \"Bar Plot\" = {\n                  if (is.numeric(data[[input$x_var]])) {\n                    p <- ggplot(data)\n                    \n                    # Build aesthetics for numeric bar plot\n                    aes_list <- list(x = as.name(input$x_var))\n                    if (input$color_by != \"\") {\n                      aes_list$fill <- as.name(input$color_by)\n                    }\n                    \n                    p + do.call(aes, aes_list) +\n                      geom_bar(position = if(input$color_by != \"\") \"dodge\" else \"stack\") +\n                      theme_minimal()\n                  } else {\n                    # For categorical variables, count first\n                    if (input$color_by != \"\") {\n                      data_summary <- data %>%\n                        count(across(all_of(c(input$x_var, input$color_by))))\n                    } else {\n                      data_summary <- data %>%\n                        count(across(all_of(input$x_var)))\n                    }\n                    \n                    # Order levels by frequency if not colored\n                    if (input$color_by == \"\") {\n                      data_summary[[input$x_var]] <- factor(\n                        data_summary[[input$x_var]],\n                        levels = data_summary[[input$x_var]][order(data_summary$n, decreasing = TRUE)]\n                      )\n                    }\n                    \n                    p <- ggplot(data_summary)\n                    \n                    # Build aesthetics for categorical bar plot\n                    aes_list <- list(x = as.name(input$x_var), y = as.name(\"n\"))\n                    if (input$color_by != \"\") {\n                      aes_list$fill <- as.name(input$color_by)\n                    }\n                    \n                    p + do.call(aes, aes_list) +\n                      geom_col(position = if(input$color_by != \"\") \"dodge\" else \"stack\") +\n                      theme_minimal()\n                  }\n                }\n    )\n    \n    # Add faceting if selected\n    if (input$facet_by != \"\") {\n      p <- p + facet_wrap(as.formula(paste(\"~\", input$facet_by)))\n    }\n    \n    # Add labels and theme\n    p + labs(title = input$plot_title,\n             x = input$x_axis_label,\n             y = input$y_axis_label) +\n      theme(plot.title = element_text(hjust = 0.5),\n            axis.text.x = element_text(angle = 45, hjust = 1))\n  })\n  \n  # Display plot\n  output$plot <- renderPlot({\n    print(current_plot())\n  })\n  \n  # Download handler for the plot\n  output$download_plot <- downloadHandler(\n    filename = function() {\n      paste0(\"plot_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".png\")\n    },\n    content = function(file) {\n      req(current_plot())\n      ggsave(file, plot = current_plot(), width = 10, height = 7, dpi = 300)\n    }\n  )\n  \n  # Statistical calculations\n  stats_calculations <- reactive({\n    req(input$x_var, filtered_data())\n    data <- filtered_data()\n    \n    # Function to generate statistics for a dataset\n    generate_stats <- function(data, group_name = NULL) {\n      # Initialize results\n      results <- list()\n      \n      # Initialize output text\n      output_text <- c(\n        if(!is.null(group_name)) paste(\"\\n=== Analysis for\", group_name, \"===\") else \"\\n=== Overall Analysis ===\",\n        \"\\nQuick Summary:\",\n        paste(capture.output(summary(data[[input$x_var]])), collapse = \"\\n\")\n      )\n      \n      # Simple and Technical Interpretations\n      output_text <- c(output_text,\n                       \"\\nSimple Interpretation:\",\n                       if(is.numeric(data[[input$x_var]])) {\n                         paste(\"Most values of\", input$x_var, \"are around\",\n                               round(mean(data[[input$x_var]], na.rm = TRUE), 2),\n                               \". The lowest value is\",\n                               round(min(data[[input$x_var]], na.rm = TRUE), 2),\n                               \"and the highest is\",\n                               round(max(data[[input$x_var]], na.rm = TRUE), 2), \".\"\n                         )\n                       } else {\n                         paste(\"This data contains\", length(unique(data[[input$x_var]])),\n                               \"different categories.\")\n                       },\n                       \"\\nTechnical Details:\",\n                       if(is.numeric(data[[input$x_var]])) {\n                         paste(\"Mean:\", round(mean(data[[input$x_var]], na.rm = TRUE), 2),\n                               \"| SD:\", round(sd(data[[input$x_var]], na.rm = TRUE), 2),\n                               \"| Range:\", round(min(data[[input$x_var]], na.rm = TRUE), 2),\n                               \"to\", round(max(data[[input$x_var]], na.rm = TRUE), 2))\n                       } else {\n                         paste(\"Categorical variable with\",\n                               length(unique(data[[input$x_var]])), \"unique values\")\n                       }\n      )\n      \n      # Shapiro-Wilk test for numeric data\n      if (is.numeric(data[[input$x_var]]) && length(data[[input$x_var]]) >= 3) {\n        results$shapiro <- tryCatch(\n          shapiro.test(data[[input$x_var]]),\n          error = function(e) NULL\n        )\n        \n        if (!is.null(results$shapiro)) {\n          simple_shapiro <- if(results$shapiro$p.value < 0.05) {\n            \"The data is not normally distributed (bell-shaped).\"\n          } else {\n            \"The data follows a normal (bell-shaped) distribution.\"\n          }\n          \n          technical_shapiro <- if(results$shapiro$p.value < 0.05) {\n            \"Significantly deviates from normality (p < 0.05). Consider non-parametric methods.\"\n          } else {\n            \"Normal distribution (p >= 0.05). Parametric tests appropriate.\"\n          }\n          \n          output_text <- c(output_text,\n                           \"\\nDistribution Check:\",\n                           paste(\"Simple:\", simple_shapiro),\n                           paste(\"Technical:\", technical_shapiro),\n                           paste(\"Test Statistics: W =\", round(results$shapiro$statistic, 4),\n                                 \", p-value =\", format.pval(results$shapiro$p.value)))\n        }\n      }\n      \n      # Scatter plot specific tests\n      if (input$plot_type == \"Scatter Plot\" && !is.null(input$y_var)) {\n        results$correlation <- tryCatch(\n          cor.test(data[[input$x_var]], data[[input$y_var]]),\n          error = function(e) NULL\n        )\n        \n        if (!is.null(results$correlation)) {\n          cor_strength <- abs(results$correlation$estimate)\n          cor_interpretation <- case_when(\n            cor_strength >= 0.7 ~ \"strong\",\n            cor_strength >= 0.3 ~ \"moderate\",\n            TRUE ~ \"weak\"\n          )\n          \n          direction <- if(results$correlation$estimate > 0)\n            \"as one increases, the other tends to increase\"\n          else\n            \"as one increases, the other tends to decrease\"\n          \n          simple_cor <- paste(\"There is a\", cor_interpretation, \"relationship:\", direction, \".\",\n                              if(results$correlation$p.value < 0.05)\n                                \"This pattern is reliable.\"\n                              else\n                                \"This pattern might be by chance.\")\n          \n          technical_cor <- paste(\n            \"Correlation coefficient (r) =\", round(results$correlation$estimate, 4),\n            sprintf(\"(p %s 0.05)\", ifelse(results$correlation$p.value < 0.05, \"<\", \"≥\"))\n          )\n          \n          output_text <- c(output_text,\n                           \"\\nRelationship Analysis:\",\n                           paste(\"Simple:\", simple_cor),\n                           paste(\"Technical:\", technical_cor))\n          \n          # Regression analysis\n          results$regression <- tryCatch(\n            summary(lm(data[[input$y_var]] ~ data[[input$x_var]])),\n            error = function(e) NULL\n          )\n          \n          if (!is.null(results$regression)) {\n            simple_reg <- paste(\"This relationship can explain\",\n                                round(results$regression$r.squared * 100, 0),\n                                \"% of the changes in\", input$y_var, \".\")\n            \n            technical_reg <- paste(\n              \"R² =\", round(results$regression$r.squared, 4),\n              \"| Adj.R² =\", round(results$regression$adj.r.squared, 4),\n              \"| Slope =\", round(results$regression$coefficients[2,1], 4),\n              sprintf(\"(p %s 0.05)\", ifelse(results$regression$coefficients[2,4] < 0.05, \"<\", \"≥\"))\n            )\n            \n            output_text <- c(output_text,\n                             \"\\nPredictive Analysis:\",\n                             paste(\"Simple:\", simple_reg),\n                             paste(\"Technical:\", technical_reg))\n          }\n        }\n      }\n      \n      # Distribution shape analysis for histograms\n      if (input$plot_type == \"Histogram\" && is.numeric(data[[input$x_var]])) {\n        skewness <- (sum((data[[input$x_var]] - mean(data[[input$x_var]]))^3) /\n                       (length(data[[input$x_var]]) * sd(data[[input$x_var]])^3))\n        \n        simple_skew <- case_when(\n          abs(skewness) < 0.5 ~ \"values are spread evenly around the middle\",\n          skewness >= 0.5 ~ \"there are more low values with some high outliers\",\n          skewness <= -0.5 ~ \"there are more high values with some low outliers\"\n        )\n        \n        technical_skew <- case_when(\n          abs(skewness) < 0.5 ~ \"approximately symmetric\",\n          skewness >= 0.5 ~ \"right-skewed (positively skewed)\",\n          skewness <= -0.5 ~ \"left-skewed (negatively skewed)\"\n        )\n        \n        output_text <- c(output_text,\n                         \"\\nShape Analysis:\",\n                         paste(\"Simple: In this dataset,\", simple_skew, \".\"),\n                         paste(\"Technical: Distribution is\", technical_skew,\n                               \"(skewness =\", round(skewness, 4), \")\"))\n      }\n      \n      paste(output_text, collapse = \"\\n\")\n    }\n    \n    # Generate overall statistics\n    all_stats <- generate_stats(data)\n    \n    # Generate statistics for each facet group if faceting is enabled\n    if (!is.null(input$facet_by) && input$facet_by != \"\") {\n      facet_groups <- split(data, data[[input$facet_by]])\n      facet_stats <- lapply(names(facet_groups), function(group) {\n        generate_stats(facet_groups[[group]], paste(input$facet_by, \"=\", group))\n      })\n      \n      # Combine overall and faceted statistics\n      paste(c(all_stats, unlist(facet_stats)), collapse = \"\\n\\n\")\n    } else {\n      all_stats\n    }\n  })\n  \n  # Render statistical analysis\n  output$stats_tests <- renderText({\n    stats_calculations()\n  })\n  \n  # Store saved plots and their descriptions\n  saved_plots <- reactiveVal(list())\n  \n  # Clear report\n  observeEvent(input$clear_report, {\n    saved_plots(list())\n    showNotification(\"Report cleared\", type = \"message\")\n  })\n  \n  # When save button is clicked, save current plot and stats\n  observeEvent(input$save_current_plot, {\n    req(current_plot())\n    \n    # Create a new plot entry\n    new_plot <- list(\n      plot = current_plot(),\n      title = input$plot_title,\n      type = input$plot_type,\n      variables = list(\n        x = input$x_var,\n        y = if(!is.null(input$y_var)) input$y_var else NULL\n      ),\n      stats = stats_calculations()\n    )\n    \n    # Add to saved plots\n    current_saved <- saved_plots()\n    saved_plots(c(current_saved, list(new_plot)))\n    \n    showNotification(\"Plot added to report\", type = \"message\")\n  })\n  \n  # Generate report preview\n  output$saved_plots_preview <- renderUI({\n    plots <- saved_plots()\n    \n    if (length(plots) == 0) {\n      return(p(\"No plots saved yet. Create plots in the Graphs tab and click 'Add Current Plot to Report' to include them here.\"))\n    }\n    \n    plot_previews <- lapply(seq_along(plots), function(i) {\n      card(\n        card_header(\n          paste0(\"Plot \", i, \": \", plots[[i]]$title)\n        ),\n        plotOutput(paste0(\"saved_plot_\", i)),\n        if(input$include_stats) {\n          verbatimTextOutput(paste0(\"saved_stats_\", i))\n        }\n      )\n    })\n    \n    # Render each saved plot\n    for(i in seq_along(plots)) {\n      local({\n        local_i <- i\n        output[[paste0(\"saved_plot_\", local_i)]] <- renderPlot({\n          plots[[local_i]]$plot\n        })\n        if(input$include_stats) {\n          output[[paste0(\"saved_stats_\", local_i)]] <- renderText({\n            plots[[local_i]]$stats\n          })\n        }\n      })\n    }\n    \n    do.call(tagList, plot_previews)\n  })\n  \n  # Preview report title\n  output$preview_title <- renderText({\n    input$report_title\n  })\n  \n  # Preview report description\n  output$preview_description <- renderText({\n    input$report_description\n  })\n  \n  # Add this output in the server function to render the data summary preview\n  output$data_summary_preview <- renderUI({\n    req(filtered_data())\n    if (!input$include_data_summary) return(NULL)\n    \n    data <- filtered_data()\n    \n    # Function to create summary for each column\n    create_col_summary <- function(col_name, col_data) {\n      if (is.numeric(col_data)) {\n        tagList(\n          h4(col_name),\n          p(strong(\"Numeric Variable Summary:\")),\n          tags$ul(\n            tags$li(paste(\"Type:\", class(col_data)[1])),\n            tags$li(paste(\"Minimum:\", round(min(col_data, na.rm = TRUE), 2))),\n            tags$li(paste(\"Maximum:\", round(max(col_data, na.rm = TRUE), 2))),\n            tags$li(paste(\"Mean:\", round(mean(col_data, na.rm = TRUE), 2))),\n            tags$li(paste(\"Median:\", round(median(col_data, na.rm = TRUE), 2))),\n            tags$li(paste(\"Standard Deviation:\", round(sd(col_data, na.rm = TRUE), 2))),\n            tags$li(paste(\"Missing Values:\", sum(is.na(col_data))))\n          )\n        )\n      } else {\n        freq_table <- table(col_data)\n        top_categories <- head(sort(freq_table, decreasing = TRUE), 5)\n        \n        tagList(\n          h4(col_name),\n          p(strong(\"Categorical Variable Summary:\")),\n          tags$ul(\n            tags$li(paste(\"Type:\", class(col_data)[1])),\n            tags$li(paste(\"Number of unique values:\", length(unique(col_data)))),\n            tags$li(paste(\"Missing Values:\", sum(is.na(col_data)))),\n            tags$li(\n              \"Top 5 most frequent categories:\",\n              tags$ul(\n                lapply(1:length(top_categories), function(i) {\n                  tags$li(paste0(\n                    names(top_categories)[i], \": \",\n                    top_categories[i], \" (\",\n                    round(100 * top_categories[i]/length(col_data), 1), \"%)\"\n                  ))\n                })\n              )\n            )\n          )\n        )\n      }\n    }\n    \n    # Create summary for dataset overview\n    overview <- tagList(\n      h2(\"Data Summary\"),\n      h3(\"Dataset Overview\"),\n      tags$ul(\n        tags$li(paste(\"Number of Observations:\", nrow(data))),\n        tags$li(paste(\"Number of Variables:\", ncol(data))),\n        tags$li(\"Types of Variables:\",\n                tags$ul(\n                  tags$li(paste(\"Numeric:\", sum(sapply(data, is.numeric)))),\n                  tags$li(paste(\"Character:\", sum(sapply(data, is.character)))),\n                  tags$li(paste(\"Factor:\", sum(sapply(data, is.factor))))\n                )\n        )\n      ),\n      h3(\"Variable Summaries\")\n    )\n    \n    # Generate summary for each column\n    col_summaries <- lapply(names(data), function(col) {\n      create_col_summary(col, data[[col]])\n    })\n    \n    # Combine all elements\n    tagList(\n      hr(),\n      overview,\n      col_summaries\n    )\n  })\n  \n  # Download report handler\n  \n  output$download_report <- downloadHandler(\n    filename = function() {\n      paste0(\"analysis_report_\", format(Sys.time(), \"%Y%m%d_%H%M%S\"), \".html\")\n    },\n    content = function(file) {\n      temp_dir <- tempfile()\n      dir.create(temp_dir)\n      on.exit(unlink(temp_dir, recursive = TRUE))\n      \n      # Create images directory\n      img_dir <- file.path(temp_dir, \"images\")\n      dir.create(img_dir)\n      \n      plots <- saved_plots()\n      \n      # Save plots as images\n      plot_files <- character(length(plots))\n      for(i in seq_along(plots)) {\n        plot_files[i] <- file.path(\"images\", paste0(\"plot_\", i, \".png\"))\n        ggsave(\n          file.path(temp_dir, plot_files[i]),\n          plots[[i]]$plot,\n          width = 10,\n          height = 7,\n          dpi = 300\n        )\n      }\n      \n      # Create CSS for better formatting\n      css_content <- \"\n    .stats-section {\n      margin: 20px 0;\n      padding: 15px;\n      background-color: #f8f9fa;\n      border-radius: 5px;\n    }\n    .stats-header {\n      color: #2c3e50;\n      margin-bottom: 10px;\n    }\n    .stats-content {\n      font-family: monospace;\n      white-space: pre-wrap;\n      margin-left: 20px;\n    }\n    .plot-section {\n      margin: 30px 0;\n      padding: 20px;\n      border: 1px solid #dee2e6;\n      border-radius: 8px;\n    }\n    .plot-title {\n      color: #2c3e50;\n      border-bottom: 2px solid #e9ecef;\n      padding-bottom: 10px;\n      margin-bottom: 20px;\n    }\n    \"\n      \n      writeLines(css_content, file.path(temp_dir, \"custom.css\"))\n      \n      # Create Rmd content\n      rmd_content <- c(\n        \"---\",\n        paste0('title: \"', input$report_title, '\"'),\n        'date: \"`r format(Sys.time(), \\'%B %d, %Y\\')`\"',\n        'output:',\n        '  html_document:',\n        '    toc: true',\n        '    toc_float: true',\n        '    theme: cosmo',\n        '    highlight: tango',\n        '    css: custom.css',\n        '    code_folding: hide',\n        \"---\",\n        \"\",\n        \"```{r setup, include=FALSE}\",\n        \"knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)\",\n        \"```\",\n        \"\",\n        \"## Description\",\n        \"\",\n        input$report_description,\n        \"\"\n      )\n      \n      # Add data summary if requested\n      # Add data summary if requested\n      if (input$include_data_summary) {\n        data <- filtered_data()\n        summary_content <- c(\n          \"## Data Summary\",\n          \"\",\n          \"### Dataset Overview\",\n          sprintf(\"* Number of Observations: %d\", nrow(data)),\n          sprintf(\"* Number of Variables: %d\", ncol(data)),\n          \"\",\n          \"### Variable Types\",\n          sprintf(\"* Numeric Variables: %d\", sum(sapply(data, is.numeric))),\n          sprintf(\"* Character Variables: %d\", sum(sapply(data, is.character))),\n          sprintf(\"* Factor Variables: %d\", sum(sapply(data, is.factor))),\n          \"\",\n          \"### First Few Rows\",\n          \"<div style='overflow-x: auto;'>\",\n          \"```{r}\",\n          \"knitr::kable(head(filtered_data(), 5), \n                  format = 'html',\n                  align = rep('c', ncol(filtered_data())),\n                  table.attr = 'class=\\\"table table-striped table-bordered\\\" style=\\\"width: auto !important; margin-left: auto; margin-right: auto; font-size: 14px;\\\"')\",\n          \"```\",\n          \"<\/div>\",\n          \"\",\n          \"### Summary Statistics\",\n          \"```{r}\",\n          \"summary(filtered_data())\",\n          \"```\"\n        )\n        rmd_content <- c(rmd_content, summary_content)\n      }\n      \n      # Add plots and statistics\n      if (length(plots) > 0) {\n        for (i in seq_along(plots)) {\n          plot_content <- c(\n            paste(\"## Plot\", i, \":\", plots[[i]]$title),\n            \"\",\n            '<div class=\"plot-section\">',\n            paste0('<div class=\"plot-title\">', plots[[i]]$title, '<\/div>'),\n            paste0(\"![](\", plot_files[i], \")\"),\n            \"<\/div>\"\n          )\n          \n          if (input$include_stats) {\n            stats_text <- plots[[i]]$stats\n            stats_content <- c(\n              \"### Statistical Analysis\",\n              '<div class=\"stats-section\">',\n              paste0('<div class=\"stats-content\">', stats_text, '<\/div>'),\n              \"<\/div>\"\n            )\n            plot_content <- c(plot_content, stats_content)\n          }\n          \n          rmd_content <- c(rmd_content, plot_content, \"\")\n        }\n      }\n      \n      # Write Rmd file\n      writeLines(rmd_content, file.path(temp_dir, \"report.Rmd\"))\n      \n      # Render the report\n      withr::with_dir(temp_dir, {\n        rmarkdown::render(\"report.Rmd\",\n                          output_format = rmarkdown::html_document(\n                            toc = TRUE,\n                            toc_float = TRUE,\n                            theme = \"cosmo\",\n                            highlight = \"tango\",\n                            css = \"custom.css\",\n                            code_folding = \"hide\"\n                          ),\n                          output_file = file,\n                          quiet = TRUE,\n                          encoding = \"UTF-8\")\n      })\n    },\n    contentType = \"text/html\"\n  )\n}\n\nshinyApp(ui, server)","type":"text"}]
